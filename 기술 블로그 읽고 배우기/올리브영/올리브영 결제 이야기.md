# 올리브영 결제 이야기 Part - 1
링크: https://oliveyoung.tech/2022-04-20/Oliveyoung-Order-Payment-Process/

## 문제
- 결제 미매칭 현상 빈도 증가
- 고객들의 불편 증가
	- PG사 결제 완료 후 올리브영 결제 완료까지 대기 시간이 증가
	- PG사에서는 결제 완료했는데 올리브영에서는 최종적으로 결제 실패하는 현상 증가

## 원인
- 올리브영은 기존에 결제 로직이 Async 방식이었다.
	- Async 방식의 결제 로직:
		1. 클라이언트가 PG사와 직접 통신하여 결제
		2. 결제완료되면 클라이언트는 올리브영에서 등록된 결제 완료 화면으로 redirect
		3. PG사는 올리브영 백엔드 서버로 결제 내역 전달 (웹 훅 방식)
		4. 클라이언트는 백엔드 서버에 폴링 방식으로 결제 완료 여부 확인
		5. 백엔드 서버는 결제 내역 저장
		6. 클라이언트에서는 백엔드 서버에서 결제 완료 여부 확인 후 결제 내역 화면 출력
- Async 방식의 문제
	- 트래픽이 몰리는 경우 PG사와 올리브영 백엔드 서버간의 통신 실패

## 해결
- Sync 방식으로 전환
	1. 클라이언트가 PG사와 직접 통신하여 결제
	2. 결제완료되면 클라이언트는 올리브영에서 등록된 결제 완료 화면으로 redirect (redirect url에 결제 승인을 위한 쿼리 파라미터 존재)
	3. 클라이언트가 올리브영 백엔드 서버 API 호출
	4. 올리브영 백엔드 서버가 PG사의 결제 승인 API 호출
	5. 올리브영 백엔드 서버가 클라이언트에게 결제 결과 응답
- Sync 방식으로 전환하니까 해결되는 이유
	- 제어권이 올리브영으로 넘어감
		- 클라이언트 <-> 서버 <-> PG사간의 통신이 안되면 올리브영 서버에서 retry를 하거나 성능 최적화를 통해 개선할 수 있음. (Async 방식에서는 PG사로부터 웹훅이 올 때 까지 대기할 수 밖에 없음)
	- 불필요한 통신이 줄어듦
		- Async방식에서는 클라이언트에서 폴링 방식으로 결제 완료 여부를 확인해야 됐으나 Sync 방식에서는 클라이언트가 백엔드 서버한테 결제 승인 요청 한 번만 보내면 됨

## 토스 페이먼츠 결제 로직
토스 페이먼츠(PG사) 결제 연동 문서를 보면 올리브영에서 전환한 Sync 방식과 동일하다.

![[Pasted image 20251204202533.png]]
https://docs.tosspayments.com/guides/v2/payment-window/integration

### 웹훅 방식을 꼭 사용해야 하는 결제방식
가상계좌 연동할 때는 웹훅 방식이 꼭 필요하다. 왜냐하면 결제가 즉시 이루어지지 않기 때문이다.
올리브영 기술 블로그에 언급된 것 처럼 PG사와 서버간의 통신이 실패할 수 있다. 토스에서는 이러한 통신 장애를 극복하기 위해 웹훅 재전송 정책이 있다.

- 가상계좌 연동 설명: https://docs.tosspayments.com/blog/virtual-account-webhook
- 웹훅 연동 설명: https://docs.tosspayments.com/guides/webhook

